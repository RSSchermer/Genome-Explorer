"use strict";angular.module("genomeExplorerApp",["restangular","ngRoute","angularSpinner","glider"]).constant("GENEDATA_SERVER_PATH","http://localhost:9876/restxq/genedata/homo_sapiens").constant("SEQUENCE_SERVER_PATH","http://localhost:5000/sequencedata/homo_sapiens/chromosome/").constant("GENES_PER_PAGE",15).config(["$routeProvider",function(a){a.when("/",{redirectTo:"/genes"}).when("/genes",{templateUrl:"views/gene_list.html",controller:"GeneListCtrl"}).when("/genes/:geneId",{templateUrl:"views/gene.html",controller:"GeneCtrl"}).when("/about",{templateUrl:"views/about.html"}).otherwise({redirectTo:"/"})}]).config(["RestangularProvider","GENEDATA_SERVER_PATH",function(a,b){a.setBaseUrl(b).setDefaultHttpFields({cache:!0}).setResponseExtractor(function(a,b){var c;return"getList"===b?(c=a.results,c.metadata={count:a.count}):c=a.results,c}).addElementTransformer("genes",!1,function(a){return a.addRestangularMethod("getExons","get","exons"),a})}]),angular.module("genomeExplorerApp").controller("MainCtrl",["$scope","AngularTour",function(a,b){var c=b.create();c.addSteps([{path:"/genes",element:"#tour-start",title:"Welcome to the Genome Explorer",content:'New to the genome explorer? You can follow this tour to learn about the main features. You can always end the tour by clicking "end tour" below and follow it at a later time should any of the functionality be unclear.',placement:"bottom"},{path:"/genes",element:"#search-query-input",title:"Search for genes",content:"Enter (part of) a gene symbol, description or locus to in order to find a particular gene.",placement:"bottom"},{path:"/genes",element:"#chromosome-filter",title:"Chromosome filter",content:"You can select one of the chromosomes from this dropdown. This will filter the genes in the search results and only show genes that lie on that particular chromosome.",placement:"bottom"},{path:"/genes",element:"#gene-type-filter",title:"Chromosome filter",content:"In the same way you can filter genes for a particular chromosome, you can also filter genes by gene type. There are several different types of genes you can filter for.",placement:"bottom"},{path:"/genes",element:"#gene-list-table",title:"Search results",content:"The genes that match your query and filters are displayed here. Results may have been divided over multiple pages. Click on a gene's symbol to view more detailed information about a gene.",placement:"top"},{path:"/genes/ACADM",element:"#gene-profile-title",title:"Gene description",content:'This page provides more information about one particular gene. It will be shown after you click on a gene\'s symbol on the search page. In this case information for the "ACADM" gene is shown.',placement:"top"},{path:"/genes/ACADM",element:"#gene-diagram-zoom-slider",title:"Gene description",content:"The diagram below shows the genes sequence and the exon distribution. This slider can be used to zoom out, giving a better overview of the position of the exons.",placement:"top"}]),a.$on("readyForTour",function(){c.start()}),a.startTour=function(){c.end(),c.restart(),c.start(!0)}}]),angular.module("genomeExplorerApp").controller("NavigationCtrl",["$scope","$location",function(a,b){a.isCurrentPath=function(a){return b.path()===a}}]),angular.module("genomeExplorerApp").controller("GeneListCtrl",["$scope","$routeParams","Restangular","$location","GENES_PER_PAGE",function(a,b,c,d,e){var f=this;a.genesPerPage=e,a.currentPage=parseInt(b.page)||1,a.chromosomeFilter=b.chromosome,a.geneTypeFilter=b.type,a.searchQuery=b.search,a.$emit("readyForTour",!0),c.all("chromosomes").getList().then(function(b){a.chromosomes=b}),c.all("genes").getList({top:e,skip:(a.currentPage-1)*e,chromosome:a.chromosomeFilter,type:a.geneTypeFilter,search:a.searchQuery}).then(function(b){a.genes=b,a.hasNextPage=b.metadata.count>a.currentPage*e,a.hasPreviousPage=1!==a.currentPage,a.genesLoaded=!0}),a.$watch("currentPage",function(){d.search(f._buildSearch(a.currentPage,a.chromosomeFilter,a.geneTypeFilter,a.searchQuery))}),a.search=function(){var b=a.searchQuery?a.searchQuery.length:0;0!==b&&4>b?a.searchError="Search query must be at least 4 characters long.":d.search(f._buildSearch(1,a.chromosomeFilter,a.geneTypeFilter,a.searchQuery))},this._buildSearch=function(a,b,c,d){var e={page:a};return b&&(e.chromosome=b),c&&(e.type=c),d&&(e.search=d),e}}]),angular.module("genomeExplorerApp").controller("GeneCtrl",["$scope","$routeParams","Restangular","$http","SEQUENCE_SERVER_PATH","$window",function(a,b,c,d,e,f){a.zoom=1,null!==b.geneId&&c.one("genes",b.geneId).get().then(function(b){a.gene=b,c.one("genes",b.symbol).getExons("exons").then(function(b){a.gene.exons=b}),b.intervalStart&&b.intervalStop&&d.get(e+b.chromosomeId+"?start="+b.intervalStart+"&stop="+b.intervalStop).then(function(b){a.sequence=b.data}),a.$emit("readyForTour",!0)}),a.backToList=function(){f.history.back()}}]),angular.module("genomeExplorerApp").factory("d3Loader",["$document","$q","$rootScope",function(a,b,c){var d=b.defer(),e=function(){c.$apply(function(){d.resolve(window.d3)})},f=a[0].createElement("script");f.type="text/javascript",f.async=!0,f.src="bower_components/d3/d3.min.js",f.onreadystatechange=function(){"complete"===this.readyState&&e()},f.onload=e;var g=a[0].getElementsByTagName("body")[0];return g.appendChild(f),{load:function(){return d.promise}}}]),angular.module("genomeExplorerApp").factory("AngularTour",["$window","$location","$rootScope",function(a,b,c){if(!a.Tour)throw new Error('Could not find object "Tour" on the window. Please include bootstrap-tour.js before initializing angular.');var d=angular.copy(a.Tour);return d.prototype._isRedirect=function(a){return null!==a&&""!==a&&a.replace(/\?.*$/,"").replace(/\/?$/,"")!==b.path()},d.prototype._redirect=function(a,d){return angular.isFunction(a.redirect)?a.redirect.call(this,d):a.redirect===!0?(this._debug("Redirect to "+d),this._inited=!1,c.$apply(b.url(d)),!0):void 0},{create:function(a){return new d(a)}}}]),angular.module("genomeExplorerApp").directive("geneSequenceDiagram",["d3Loader","$window","$timeout",function(a,b,c){return{restrict:"E",scope:{gene:"=",plusSequence:"=",zoom:"="},link:function(d,e,f){var g,h,i,j,k,l={A:"T",T:"A",C:"G",G:"C"},m=f.exonColor||"#AAA",n=f.plusStrandColor||"#EB2F32",o=f.minusStrandColor||"#3C36EB";a.load().then(function(a){var f=a.select(e[0]).append("svg");window.onresize=function(){d.$apply()},d.$watch(function(){return angular.element(b)[0].innerWidth},function(){j=null,d.render(d.gene,h,i,d.zoom)}),d.$watch("gene",function(a){d.render(a,h,i,d.zoom)},!0),d.$watch("plusSequence",function(a){a&&(h=a,i=a.replace(/A|T|C|G/g,function(a){return l[a]||a}),k=null,d.render(d.gene,h,i,d.zoom))}),d.$watch("zoom",function(a){d.render(d.gene,h,i,a)}),d.render=function(a,b,d,e){a&&b&&d&&a.intervalStart&&a.intervalStop&&a.exons&&(g&&clearTimeout(g),g=c(function(){e=null===e||void 0===e?1:Math.pow(e,6);var c=parseInt(a.intervalStart),g=parseInt(a.intervalStop),h=g-c;f.selectAll("*").remove(),f.style("height","90px");var i=f.append("g"),l=f.append("text").text(b).attr("font-family","monospace").attr("font-size",20).attr("fill",n).attr("y",40);l.append("svg:title").text("Plus strand"),j||(f.style("width","100%"),j=f.node().parentNode.offsetWidth),k||(k=l.node().getComputedTextLength());var p=j+(k-j)*e;f.style("width",p+"px"),1===Number(e)?f.append("text").text(d).attr("font-family","monospace").attr("font-size",20).attr("fill",o).attr("y",63).append("svg:title").text("Minus strand"):l.remove(),f.append("line").attr("y1",20).attr("y2",20).attr("x1",0).attr("x2",p).attr("stroke-width",5).attr("stroke",n),f.append("line").attr("y1",70).attr("y2",70).attr("x1",0).attr("x2",p).attr("stroke-width",5).attr("stroke",o),f.append("rect").attr("height",14).attr("width",24).attr("y",1).attr("x",0).attr("fill",n).append("svg:title").text("Legend"),f.append("text").text("Plus Strand").attr("font-family","sans-serif").attr("font-size",12).attr("fill",n).attr("font-weight","bold").attr("y",13).attr("x",29).append("svg:title").text("Legend"),f.append("rect").attr("height",14).attr("width",24).attr("y",1).attr("x",110).attr("fill",o).append("svg:title").text("Legend"),f.append("text").text("Minus Strand").attr("font-family","sans-serif").attr("font-size",12).attr("fill",o).attr("font-weight","bold").attr("y",13).attr("x",139).append("svg:title").text("Legend"),f.append("rect").attr("height",14).attr("width",24).attr("y",1).attr("x",230).attr("fill",m).append("svg:title").text("Legend"),f.append("text").text("Exon").attr("font-family","sans-serif").attr("font-size",12).attr("fill",m).attr("font-weight","bold").attr("y",13).attr("x",259).append("svg:title").text("Legend"),i.selectAll("rect").data(a.exons).enter().append("rect").attr("height",23).attr("width",function(a){return Math.ceil((parseInt(a.intervalStop)-parseInt(a.intervalStart))/h*p)}).attr("y",function(a){return"plus"===a.strand?22:45}).attr("x",function(a){return(parseInt(a.intervalStart)-c)/h*p}).attr("fill",m).attr("title","Exon").append("svg:title").text(function(a){return"Exon - "+a.product})},300))}})}}}]);